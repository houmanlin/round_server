<template>
  <div class="view_container">
    <!---------------   搜索  ----------------->
    <search @onGetFieldData="getFieldData" @exportFiles="exportFile"/>

    <!-----------  用户的增删改查按钮  ---------->
    <operatorGroup @onOperator="operator"/>


    <!------------- 数据表格  --------------->
    <components_table :table-header="table_header" :house_bill_header="house_bill_table_header" :tableData="table_data" @onTableOperator="tableOperatorGroup" @onOperator="tableOperator" @onUploadMethod="uploadFile" @onGetSelectData="getSelectData"/>
    <el-pagination
        class="pagination"
        :pagerCount="21"
        :current-page="page_config.current"
        layout="prev, pager, next"
        :total="page_config.total"
        @current-change="checkPage"
    >
    </el-pagination>

    <!--  各种对话框  -->

    <clearanceGoods ref="clearanceGoods" :mainNo="orderInfo.mainNo" @onUploadSuccess="uploadSuccess"/>
    <inspect ref="inspect" :mainNo="orderInfo.mainNo" @onUploadSuccess="uploadSuccess"/>
    <returnSale ref="returnSale" :mainNo="orderInfo.mainNo" @onUploadSuccess="uploadSuccess"/>
    <returnSaleSucc ref="returnSaleSucc" :mainNo="orderInfo.mainNo" @onUploadSuccess="uploadSuccess"/>
    <returnWorkhouse ref="returnWorkhouse" :mainNo="orderInfo.mainNo" @onUploadSuccess="uploadSuccess"/>
    <greenLight ref="greenLight" :mainNo="orderInfo.mainNo" @onUploadSuccess="uploadSuccess"/>
    <domesticDeliveryGoods ref="domesticDeliveryGoods" :mainNo="orderInfo.mainNo" @onUploadSuccess="uploadSuccess"/>
    <domesticDelivery ref="domesticDelivery" :mainNo="orderInfo.mainNo" @onUploadSuccess="uploadSuccess"/>
    <submitCarInfo ref="submitCarInfo" :mainNo="orderInfo.mainNo" @onUploadSuccess="uploadSuccess"/>
    <submitCustomsTransit ref="submitCustomsTransit" :mainNo="orderInfo.mainNo" @onUploadSuccess="uploadSuccess"/>
    <orderInfoDialog ref="orderInfoDialog" :orderInfo="orderInfo" />
    <orderMaterialDialog v-if="orderMater" :orderInfo="orderInfo" @onCloseDialog="closeDialog"/>
  </div>
</template>

<script>
import search from "./components/searchComponent";
import operatorGroup from "./components/operatorButtonGroup";
import components_table from "./components/componentsTable";
import {HOSE_BILL_TABLE, IMPORT_BUSINESS_TABLE} from "@/config/tableData";
import clearanceGoods from "@/views/import_business/submit_dialog/clearance_goods";
import inspect from "@/views/import_business/submit_dialog/inspect";
import returnSale from "@/views/import_business/submit_dialog/return_sale";
import returnSaleSucc from "@/views/import_business/submit_dialog/return_sale_succ";
import returnWorkhouse from "@/views/import_business/submit_dialog/return_workhouse";
import greenLight from "@/views/import_business/submit_dialog/green_light";
import domesticDeliveryGoods from "@/views/import_business/submit_dialog/domestic_delivery_goods";
import domesticDelivery from "@/views/import_business/submit_dialog/domestic_delivery";
import submitCarInfo from "@/views/import_business/submit_dialog/submit_car_info";
import submitCustomsTransit from "@/views/import_business/submit_dialog/submit_customs_transit";
import orderInfoDialog from "@/views/import_business/components/orderInfoDialog";
import orderMaterialDialog from "@/views/import_business/components/orderMaterialDialog";
import {getImportBussiness} from "@/api/import_bussiness";
import {getPages} from "@/utils/utils";
export default {
  components:{ search,
    components_table,
    operatorGroup,
    clearanceGoods,
    inspect,
    returnSale,
    returnSaleSucc,
    returnWorkhouse,
    greenLight,
    domesticDelivery,
    submitCarInfo,
    submitCustomsTransit,
    domesticDeliveryGoods,
    orderInfoDialog,
    orderMaterialDialog
  },
  data() {
    return {
      orderInfo: {},
      table_header            : IMPORT_BUSINESS_TABLE,      //表格表头信息
      house_bill_table_header : HOSE_BILL_TABLE,      //表格表头信息
      page_config             : {},
      table_data              : [],
      mainNo                  : "",
      submenuNo               : "",
      flightNo                : "",
      customerIdOne           : "",                // 一级客户
      customerIdTwo           : "",               // 二级客户
      exitPort                : "",           // 离境港口
      declarationDate         : "",                  // 离境港口
      flightDateStart         : "",                  // 报关时间
      flightDateEnd           : "",                  // 报关时间
      status                  : "",        // 操作类
      orderMater              : false,
      selectTableData         : []
    }
  },
  created() {
    this.page_config = getPages()
    this.getData();
  },

  methods: {

    getData(){
      let data = {
        limit                   : this.page_config.limit,
        page                    : this.page_config.current,
        mainNo                  : this.mainNo          ,
        submenuNo               : this.submenuNo       ,
        flightNo                : this.flightNo        ,
        customerIdOne           : this.customerIdOne   ,               // 一级客户,                // 一级客户
        customerIdTwo           : this.customerIdTwo   ,              // 二级客户,               // 二级客户
        exitPort                : this.exitPort        ,          // 离境港口,           // 离境港口
        declarationDate         : this.declarationDate ,                 // 离境港口,                  // 离境港口
        flightDateStart         : this.flightDateStart ,                 // 报关时间,                  // 报关时间
        flightDateEnd           : this.flightDateEnd ,                 // 报关时间,                  // 报关时间
        status                  : this.status          ,       // 操作类,        // 操作类
      }
      // let a = "?"
      // for (let i in data){
      //   a += i == 'status' ?  i+"=${this."+ i +"}" : i+"=${this."+ i +"}&"
      // }
      // console.log(a)

      getImportBussiness(data).then(res=>{
        this.page_config = getPages(res.data)
        let { records } = res.data
        this.table_data = records
      })
    },

    uploadSuccess(){
      this.getData();
    },



    /***
     * 提交重置
     */
    tableOperator(row, operator_key){
      this.orderInfo = row[0]
      this.$refs["orderInfoDialog"].dialogVisible = true
    },
    /**
     * 添加用户
     */
    operator(operator_key){
      if(operator_key == 'add'){
        this.$router.push("add_import_business")
        return
      }
      if(this.selectTableData.length > 1){
        this.$message.info("只能操作一条订单")
        return
      }
      if(this.selectTableData.length < 1){
        this.$message.info("请选择要操作的数据")
        return
      }
      console.log(this.selectTableData)
      this.orderInfo = this.selectTableData[0]
      this.$refs[operator_key].dialogVisible = true
    },
    tableOperatorGroup(operator){
      let {table_data } = operator
      if (operator.operator_key == '查看'){
        this.orderInfo = operator.table_data
        this.orderMater = true
      }

      if(operator.operator_key == "下载"){
        window.open(
            `${process.env.VUE_APP_URL}/busUploadFile/downloadFile?fileType=0&mainNo=${table_data.mainNo}&nodeType=0`)
      }
      if(operator.operator_key == "编辑"){
        this.$router.push(`add_import_business?id=${table_data.id}`)
      }

    },
    checkPage(e){
      this.page_config.current = e
      this.getData()
    },
    closeDialog(){
      this.orderMater = false
    },
    exportFile(){
      let ids = []
      for (let select_key in this.selectTableData){
        ids.push(this.selectTableData[select_key].id)
      }
      ids = ids.join(",")

      let export_file_params = `limit=${this.page_config.limit}&page=${this.page_config.current}&mainNo=${this.mainNo}&submenuNo=${this.submenuNo}&flightNo=${this.flightNo}&customerIdOne=${this.customerIdOne}&customerIdTwo=${this.customerIdTwo}&exitPort=${this.exitPort}&declarationDate=${this.declarationDate}&flightDateStart=${this.flightDateStart}&flightDateEnd=${this.flightDateEnd}&status=${this.status}&ids=${ids}`
      window.open(`${process.env.VUE_APP_URL}/busMain/export?${export_file_params}`)
    },
    getFieldData(data){
      this.mainNo = data.mainNo                // 主单号
      this.submenuNo = data.submenuNo                   // 分单号
      this.flightNo = data.flightNo                   // 航班号
      this.customerIdOne = data.customerIdOne                   // 一级客户
      this.customerIdTwo = data.customerIdTwo                  // 二级客户
      this.exitPort = data.exitPort                   // 离境港口
      this.declarationDate = data.declarationDate                   // 离境港口
      this.flightDateStart = data.flightDateStart                   // 报关时间
      this.flightDateEnd = data.flightDateEnd                   // 报关时间
      this.status = data.status                  // 操作类型
      this.page_config.current = 1                  // 操作类型


      this.getData();
    },
    getSelectData(data){
      this.selectTableData = data
    },
    uploadFile(data){
      reque
    }

  }
}
</script>

